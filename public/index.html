const functions = require('firebase-functions');
const admin = require('firebase-admin');admin.initializeApp();
const db = admin.firestore();// --- Функция 1: Самодиагностика ---
exports.systemHealth = functions.https.onRequest(async (request, response) => {
    let healthStatus = 'OK';
    const checks = {};
    checks.server = {status: 'PASSED', message: 'Cloud Function работи.'};
    
    try {
        await db.collection('system_checks').doc('health_test').get();
        checks.database = {status: 'PASSED', message: 'Firestore е достъпен.'};
    } catch (error) {
        checks.database = {status: 'FAILED', message: `Грешка: ${error.message}`};
        healthStatus = 'ERROR';
    }    response.json({ status: healthStatus, checks: checks });
});// --- Функция 2: Поздрав ---
exports.greetUserDB = functions.https.onRequest(async (request, response) => {
  const userName = request.query.name;
  let greetingMessage;  if (userName) {
    const userRef = db.collection('users').doc(userName);
    const doc = await userRef.get();    if (doc.exists) {
      greetingMessage = `Здравей отново, ${userName}! Радвам се да те видя пак.`;
    } else {
      await userRef.set({ firstVisit: new Date() });
      greetingMessage = `Здравей, ${userName}! Вече си записан в базата.`;
    }
  } else {
    greetingMessage = "Здравей! Как се казваш?";
  }  response.send(greetingMessage);
});